# vim: set ft=yaml ts=2 expandtab:
---

- name: install rest-server
  hosts: ci_group
  environment:
    http_proxy: http://ci-proxy:3128
    https_proxy: http://ci-proxy:3128
  pre_tasks:
    - name: dependencies are present
      package:
        name: python3-passlib  # for htpasswd
  roles:
    - role: mafalb.copr.plugin
    - role: mafalb.copr.repo
      repo: jeremythecat/restic
    - role: mafalb.restic.restserver
      options:
        - --append-only
        - --private-repos
    - role: mafalb.restic.job
      job: rest_server_job
      repo: rest_server_repo
      paths:
        - /etc
    - role: mafalb.restic.repo
      repo: rest_server_repo
      url: rest:http://rest_server_repo:testpass1@localhost:8000/rest_server_repo
  tasks:
    - name: htpasswd is present
      htpasswd:
        name: rest_server_repo
        password: testpass1
        path: /var/lib/rest-server/htpasswd
        mode: '640'
        group: restic

...
